name: CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

    - name: Set up Go
      uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff
      with:
        go-version: '1.24'

    - name: Build
      run: |
        mkdir -p dist
        go build -v -o dist/roady ./cmd/roady
        go build -v -o dist/roady-plugin-mock ./cmd/roady-plugin-mock

    - name: Test
      run: go test -v -coverprofile=coverage.out ./...

    - name: Security Scan (Verdict)
      run: |
        # In a real environment, we'd install verdict or use a container
        # For now, we simulate the scan if the binary is missing
        if command -v verdict &> /dev/null; then
          verdict scan .
        else
          echo "Verdict not found, skipping security scan in CI environment."
        fi
      continue-on-error: true

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff
        with:
          go-version: '1.24'
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
